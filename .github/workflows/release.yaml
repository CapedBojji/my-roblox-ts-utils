name: Build, Prepare, and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  prepare-and-release:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '14'

    - name: Install Dependencies
      run: npm install

    - name: Build Project
      run: npm run build

    - name: Prepare Publish Directory
      run: |
        mkdir -p publish/src
        cp -R out/* publish/src/
        find src -name '*.d.ts' -exec cp {} publish/src/ \;
        cp package.json publish/

    - name: Archive Publish Directory
      run: |
        cd publish
        zip -r ../publish.zip ./*
        cd ..

    - name: Create GitHub Release
      run: |
        gh release create ${{ github.ref_name }} \
          --title "Release ${{ github.ref_name }}" \
          --notes "Automatically generated release" \
          --draft=false \
          --prerelease=false \
          ../publish.zip
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
